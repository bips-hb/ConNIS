---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# ConNIS <img src="./man/figures/logo.svg" alt="ConNIS" align="right" width="120"/>

<!-- badges: start -->
<!-- badges: end -->

The `ConNIS` package provides multiple methods for determining essential genes based on insertion sites of *TraDIS* data. It also supports the data driven determination of tuning/threshold value selection by the implementation of a subsample based instability approach. Currently the follwing methods are implemented:

* the *Consecutive Non-Insertion Sites* (ConNIS) method (Hanke et al. (2025))
* an implementation of the *Binomial* approach  of the `TSAS 2.0`  package with an additional weigh parameter
* an implementation of the *Tn5Gaps* method of the `TRANSIT` package with an additional weigh parameter
* the determination of essential genes by applying the geometric distribution


## Installation

You can install the development version of ConNIS from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("moritz-hanke/ConNIS")
```

## Example

This is a basic example which shows you how to solve a common problem:

```{r exampleRunConNIS}

library(ConNIS)

# Use the E. coli BW 25113 dataset but only the first 250 genes
truncated_ecoli <- ecoli_bw25113[1:250,]

# load the insertion sites by Goodall, 2018, but omit all insertion sites beyond
# the 250th gene
truncated_is_pos <- is_pos[is_pos <= max(truncated_ecoli$end)]

# run ConNIS with weight = 1
results_ConNIS <- 
  ConNIS(ins.positions = truncated_is_pos, 
       gene.names = truncated_ecoli$gene, 
       gene.starts = truncated_ecoli$start, 
       gene.stops = truncated_ecoli$end, 
       genome.length = max(truncated_ecoli$end), 
       weight = 1)

results_ConNIS
```

Using the `p.adjust()` function we use the "Bonferroni correction" for the multiple testing problem and select the genes that are siginificant.

```{r exampleGetSignificantGenes}

results_ConNIS$adjusted_p_value <-
  p.adjust(results_ConNIS$p_value, method = "bonferroni") <= 0.05

(
  results_ConNIS %>% 
    filter(adjusted_p_value) 
  )$gene
```
We declare 55 genes to be essential (note, this is not the complete data set).

Next, we re-reun ConNIS but with a smaller weight

```{r rerunConNIS}
results_ConNIS <- 
  ConNIS(ins.positions = truncated_is_pos, 
       gene.names = truncated_ecoli$gene, 
       gene.starts = truncated_ecoli$start, 
       gene.stops = truncated_ecoli$end, 
       genome.length = max(truncated_ecoli$end), 
       weight = 0.3)

results_ConNIS$adjusted_p_value <-
  p.adjust(results_ConNIS$p_value, method = "bonferroni") <= 0.05

(
  results_ConNIS %>% 
    filter(adjusted_p_value) 
  )$gene

```
Only 39 genes are declared essential since smaller weights will make it harder to label a gene by chance as 'essential'. 

Next, we compare ConNIS with Binomial, Gemeotric and Tn5Gaps all with the same weigth.

```{r comparisonMethods}
results_Binomial <- 
  Binomial(ins.positions = truncated_is_pos, 
       gene.names = truncated_ecoli$gene, 
       gene.starts = truncated_ecoli$start, 
       gene.stops = truncated_ecoli$end, 
       genome.length = max(truncated_ecoli$end), 
       weight = 0.3)

results_Binomial$adjusted_p_value <-
  p.adjust(results_Binomial$p_value, method = "bonferroni") <= 0.05

ess_genes_Binomial <- 
  (
  results_Binomial %>% 
    filter(adjusted_p_value) 
  )$gene

results_ConNIS <- 
  ConNIS(ins.positions = truncated_is_pos, 
       gene.names = truncated_ecoli$gene, 
       gene.starts = truncated_ecoli$start, 
       gene.stops = truncated_ecoli$end, 
       genome.length = max(truncated_ecoli$end), 
       weight =  0.3)

results_ConNIS$adjusted_p_value <-
  p.adjust(results_ConNIS$p_value, method = "bonferroni") <= 0.05

ess_genes_ConNIS <- 
  (
  results_ConNIS %>% 
    filter(adjusted_p_value) 
  )$gene

results_Geometric <- 
  Geometric(ins.positions = truncated_is_pos, 
       gene.names = truncated_ecoli$gene, 
       gene.starts = truncated_ecoli$start, 
       gene.stops = truncated_ecoli$end, 
       genome.length = max(truncated_ecoli$end), 
       weight =  0.3)

results_Geometric$adjusted_p_value <-
  p.adjust(results_Geometric$p_value, method = "bonferroni") <= 0.05

ess_genes_Geometric <- 
  (
  results_Geometric %>% 
    filter(adjusted_p_value) 
  )$gene

results_Tn5Gaps <- 
  Tn5Gaps(ins.positions = truncated_is_pos, 
       gene.names = truncated_ecoli$gene, 
       gene.starts = truncated_ecoli$start, 
       gene.stops = truncated_ecoli$end, 
       genome.length = max(truncated_ecoli$end), 
       weight = 0.3)

results_Tn5Gaps$adjusted_p_value <-
  p.adjust(results_Tn5Gaps$p_value, method = "bonferroni") <= 0.05

ess_genes_Tn5Gaps <- 
  (
  results_Tn5Gaps %>% 
    filter(adjusted_p_value) 
  )$gene
```

We use a Venn diagramm to compare the results:

```{r}
library(ggvenn)

ess_genes <- list(
  `Binomial` = ess_genes_Binomial,
  `ConNIS` = ess_genes_ConNIS,
  `Geometric` = ess_genes_Geometric,
  `Tn5Gaps` = ess_genes_Tn5Gaps
)

ggvenn(ess_genes)

```

You can also embed plots, for example:

```{r pressure, echo = FALSE}
#plot(pressure)
```

In that case, don't forget to commit and push the resulting figure files, so they display on GitHub and CRAN.
